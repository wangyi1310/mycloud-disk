# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        
    - name: Build
      run: go build -v ./...
      
    - name: Test
      run: go test -v ./...

  build_image:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      name: Check out code
      
    - name: set environment variables
      id: env_vars
      run: |
        COMMIT_ID=${{ github.sha }}
        SHORT_COMMIT_ID=${COMMIT_ID:0:7}
        CURRENT_TIME=$(TZ="Asia/Shanghai" date +"%Y%m%d%H%M%S")
        TAG="${SHORT_COMMIT_ID}-${CURRENT_TIME}"
        echo "::set-output name=tag::$TAG"
    
    - name: build && push image
      uses: mr-smithers-excellent/docker-build-push@v6
      with:
        image: mycloud-disk
        tags:  ${{ steps.env_vars.outputs.tag }}
        registry: ccr.ccs.tencentyun.com/ottoypwang12111
        dockerfile: Dockerfile
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
  
